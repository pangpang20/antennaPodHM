import { Podcast } from '../model/Podcast';
import { Episode, DownloadStatus } from '../model/Episode';
import { PodcastService } from '../service/PodcastService';
import { DatabaseService } from '../service/DatabaseService';
import { PlayerService } from '../service/PlayerService';
import { DownloadService } from '../service/DownloadService';
import { router } from '@kit.ArkUI';

@Entry
@Component
struct MainPage {
  @State currentTabIndex: number = 0;
  @State podcasts: Podcast[] = [];
  @State isLoading: boolean = false;
  @State hasCurrentEpisode: boolean = false;
  @State currentEpisode: Episode | null = null;
  @State isPlaying: boolean = false;
  @State playProgress: number = 0;
  @State downloadingEpisodes: Episode[] = [];
  @State downloadedEpisodes: Episode[] = [];
  private playerService: PlayerService = PlayerService.getInstance();
  private downloadUpdateTimer: number = -1;
  private playUpdateTimer: number = -1;

  aboutToAppear() {
    this.loadSubscriptions();
    this.checkCurrentEpisode();
    this.loadDownloads();
    this.startPlayUpdateTimer();
    
    // ÁõëÂê¨Êí≠ÊîæÁä∂ÊÄÅÂèòÂåñ
    this.playerService.addEventListener('stateChange', () => {
      this.checkCurrentEpisode();
    });
  }

  aboutToDisappear() {
    if (this.downloadUpdateTimer !== -1) {
      clearInterval(this.downloadUpdateTimer);
      this.downloadUpdateTimer = -1;
    }
    if (this.playUpdateTimer !== -1) {
      clearInterval(this.playUpdateTimer);
      this.playUpdateTimer = -1;
    }
  }

  /**
   * ÂêØÂä®Êí≠ÊîæÁä∂ÊÄÅÊõ¥Êñ∞ÂÆöÊó∂Âô®
   */
  startPlayUpdateTimer() {
    this.playUpdateTimer = setInterval(() => {
      this.checkCurrentEpisode();
    }, 500);
  }

  onPageShow() {
    // È°µÈù¢ÈÄöËøáË∑ØÁî±ËøîÂõûÊó∂Âà∑Êñ∞ËÆ¢ÈòÖÂàóË°®
    this.loadSubscriptions();
    this.checkCurrentEpisode();
    this.loadDownloads();
  }

  /**
   * Âä†ËΩΩ‰∏ãËΩΩÂàóË°®
   */
  async loadDownloads() {
    try {
      const db = DatabaseService.getInstance();
      const allEpisodes = await db.getAllEpisodes();
      
      this.downloadingEpisodes = allEpisodes.filter(e => {
        const status = Number(e.downloadStatus);
        return status === DownloadStatus.DOWNLOADING;
      });
      
      this.downloadedEpisodes = allEpisodes.filter(e => {
        const status = Number(e.downloadStatus);
        return status === DownloadStatus.DOWNLOADED;
      });
      
      console.info(`[MainPage] Downloads - Downloading: ${this.downloadingEpisodes.length}, Downloaded: ${this.downloadedEpisodes.length}`);
    } catch (error) {
      console.error('[MainPage] Failed to load downloads:', error);
    }
  }

  /**
   * ÂºÄÂßã‰∏ãËΩΩÊõ¥Êñ∞ÂÆöÊó∂Âô®
   */
  startDownloadUpdateTimer() {
    if (this.downloadUpdateTimer === -1) {
      this.downloadUpdateTimer = setInterval(() => {
        this.loadDownloads();
      }, 1000);
    }
  }

  /**
   * ÂÅúÊ≠¢‰∏ãËΩΩÊõ¥Êñ∞ÂÆöÊó∂Âô®
   */
  stopDownloadUpdateTimer() {
    if (this.downloadUpdateTimer !== -1) {
      clearInterval(this.downloadUpdateTimer);
      this.downloadUpdateTimer = -1;
    }
  }

  /**
   * Âä†ËΩΩËÆ¢ÈòÖÂàóË°®
   */
  async loadSubscriptions() {
    this.isLoading = true;
    try {
      this.podcasts = await PodcastService.getInstance().getSubscribedPodcasts();
    } catch (error) {
      console.error('Failed to load subscriptions:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * Ê£ÄÊü•ÊòØÂê¶ÊúâÊ≠£Âú®Êí≠ÊîæÁöÑÂçïÈõÜ
   */
  checkCurrentEpisode() {
    this.currentEpisode = this.playerService.getCurrentEpisode();
    this.hasCurrentEpisode = this.currentEpisode !== null;
    this.isPlaying = this.playerService.getState() === 'playing';
    
    if (this.currentEpisode) {
      const position = this.playerService.getCurrentPosition();
      const duration = this.playerService.getDuration();
      this.playProgress = duration > 0 ? (position / duration) * 100 : 0;
    }
  }

  /**
   * ÊâìÂºÄÊí≠ÊîæÈ°µÈù¢
   */
  openPlayerPage() {
    const currentEpisode = this.playerService.getCurrentEpisode();
    if (currentEpisode) {
      router.pushUrl({
        url: 'pages/PlayerPage',
        params: { episodeId: currentEpisode.id }
      }).catch((err: Error) => {
        console.error('Navigation failed:', err);
      });
    }
  }

  build() {
    Column() {
      // È°∂ÈÉ®Ê†áÈ¢òÊ†è
      this.buildHeader();

      // TabÈ°µÁ≠æ
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildSubscriptionTab();
        }.tabBar('ËÆ¢ÈòÖ')

        TabContent() {
          this.buildEpisodesTab();
        }.tabBar('ÂçïÈõÜ')

        TabContent() {
          this.buildQueueTab();
        }.tabBar('ÈòüÂàó')

        TabContent() {
          this.buildDownloadsTab();
        }.tabBar('‰∏ãËΩΩ')
      }
      .barMode(BarMode.Fixed)
      .barHeight(56)
      .onChange((index: number) => {
        this.currentTabIndex = index;
        // ÂàáÊç¢Âà∞‰∏ãËΩΩ tab Êó∂ÂêØÂä®ÂÆöÊó∂Âà∑Êñ∞
        if (index === 3) {
          this.loadDownloads();
          this.startDownloadUpdateTimer();
        } else {
          this.stopDownloadUpdateTimer();
        }
      })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_light'))
  }

  /**
   * ÊûÑÂª∫Â§¥ÈÉ®
   */
  @Builder
  buildHeader() {
    Row() {
      Text('AntennaPodHM')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary_light'))

      Blank()

      // ÊêúÁ¥¢ÊåâÈíÆ
      Button() {
        Text('üîç')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('======>>> Click: Search button');
        // Ë∑≥ËΩ¨Âà∞ÊêúÁ¥¢È°µÈù¢
        router.pushUrl({ url: 'pages/SearchPage' }).catch((err: Error) => {
          console.error('Navigation failed:', err);
        });
      })

      // ËÆæÁΩÆÊåâÈíÆ
      Button() {
        Text('‚öôÔ∏è')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('======>>> Click: Settings button');
        // Ë∑≥ËΩ¨Âà∞ËÆæÁΩÆÈ°µÈù¢
        router.pushUrl({ url: 'pages/SettingsPage' }).catch((err: Error) => {
          console.error('Navigation failed:', err);
        });
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
  }

  /**
   * ËÆ¢ÈòÖÈ°µÁ≠æ
   */
  @Builder
  buildSubscriptionTab() {
    Column() {
      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
      } else if (this.podcasts.length === 0) {
        this.buildEmptyView('ÊöÇÊó†ËÆ¢ÈòÖ', 'ÁÇπÂáªÂè≥‰∏äËßíÊ∑ªÂä†Êí≠ÂÆ¢');
      } else {
        List({ space: 12 }) {
          ForEach(this.podcasts, (podcast: Podcast) => {
            ListItem() {
              this.buildPodcastItem(podcast);
            }
          }, (podcast: Podcast) => podcast.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }

      // Ê≠£Âú®Êí≠ÊîæËø∑‰Ω†Êí≠ÊîæÂô®
      if (this.hasCurrentEpisode && this.currentEpisode) {
        this.buildMiniPlayer();
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ÂçïÈõÜÈ°µÁ≠æ
   */
  @Builder
  buildEpisodesTab() {
    Column() {
      this.buildEmptyView('ÊöÇÊó†ÂçïÈõÜ', 'ËÆ¢ÈòÖÊí≠ÂÆ¢ÂêéÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå');
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ÈòüÂàóÈ°µÁ≠æ
   */
  @Builder
  buildQueueTab() {
    Column() {
      this.buildEmptyView('Êí≠ÊîæÈòüÂàó‰∏∫Á©∫', 'Ê∑ªÂä†ÂçïÈõÜÂà∞ÈòüÂàó');
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ‰∏ãËΩΩÈ°µÁ≠æ
   */
  @Builder
  buildDownloadsTab() {
    Column() {
      // ‰∏ãËΩΩ‰∏≠ÈÉ®ÂàÜ
      if (this.downloadingEpisodes.length > 0) {
        Text('‰∏ãËΩΩ‰∏≠')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 8 })
        
        List({ space: 8 }) {
          ForEach(this.downloadingEpisodes, (episode: Episode) => {
            ListItem() {
              Column() {
                Row() {
                  Text(episode.title)
                    .fontSize(14)
                    .layoutWeight(1)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(`${episode.downloadProgress}%`)
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary_light'))
                }
                .width('100%')

                Progress({ value: episode.downloadProgress, total: 100, type: ProgressType.Linear })
                  .width('100%')
                  .margin({ top: 8 })
              }
              .width('100%')
              .padding(12)
              .backgroundColor(Color.White)
              .borderRadius(8)
            }
          }, (episode: Episode) => episode.id)
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }

      // Â∑≤‰∏ãËΩΩÈÉ®ÂàÜ
      if (this.downloadedEpisodes.length > 0) {
        Text('Â∑≤‰∏ãËΩΩ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 8 })
        
        List({ space: 8 }) {
          ForEach(this.downloadedEpisodes, (episode: Episode) => {
            ListItem() {
              Row() {
                Column() {
                  Text(episode.title)
                    .fontSize(14)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(episode.getFormattedFileSize())
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary_light'))
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Button('Âà†Èô§')
                  .height(32)
                  .fontSize(12)
                  .onClick(() => {
                    console.info(`======>>> Click: Delete downloaded - ${episode.title}`);
                    DownloadService.getInstance().deleteDownloadedFile(episode);
                    this.loadDownloads();
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor(Color.White)
              .borderRadius(8)
            }
          }, (episode: Episode) => episode.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
      }

      // Á©∫Áä∂ÊÄÅ
      if (this.downloadingEpisodes.length === 0 && this.downloadedEpisodes.length === 0) {
        this.buildEmptyView('ÊöÇÊó†‰∏ãËΩΩ', '‰∏ãËΩΩÂçïÈõÜ‰ª•‰æøÁ¶ªÁ∫øÊî∂Âê¨');
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * Êí≠ÂÆ¢È°π
   */
  @Builder
  buildPodcastItem(podcast: Podcast) {
    Row() {
      // Êí≠ÂÆ¢Â∞ÅÈù¢
      Image(podcast.imageUrl)
        .width(80)
        .height(80)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))

      // Êí≠ÂÆ¢‰ø°ÊÅØ
      Column() {
        Text(podcast.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(podcast.author)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 4 })

        Text(`${podcast.episodeCount} ÈõÜ`)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      console.info(`======>>> Click: Podcast item - ${podcast.title}`);
      // Ë∑≥ËΩ¨Âà∞Êí≠ÂÆ¢ËØ¶ÊÉÖÈ°µ
      router.pushUrl({
        url: 'pages/PodcastDetailPage',
        params: { podcastId: podcast.id }
      }).catch((err: Error) => {
        console.error('Navigation failed:', err);
      });
    })
  }

  /**
   * ÊûÑÂª∫Ëø∑‰Ω†Êí≠ÊîæÂô® - QQÈü≥‰πêÈ£éÊ†º
   */
  @Builder
  buildMiniPlayer() {
    Column() {
      // ËøõÂ∫¶Êù°
      Row() {
        Progress({ value: this.playProgress, total: 100, type: ProgressType.Linear })
          .width('100%')
          .height(2)
          .color('#FF6B9D')
          .backgroundColor('#E0E0E0')
      }
      .width('100%')

      // Êí≠ÊîæÂô®ÂÜÖÂÆπ
      Row() {
        // Â∞ÅÈù¢ÂõæÔºàÂ∏¶ÊóãËΩ¨ÊïàÊûúÁöÑËÆæËÆ°Ôºâ
        Stack() {
          // ÂúÜÂΩ¢ËÉåÊôØ
          Circle()
            .width(50)
            .height(50)
            .fill('#1a1a2e')
          
          // Â∞ÅÈù¢Âõæ
          Image(this.currentEpisode?.imageUrl || '')
            .width(44)
            .height(44)
            .borderRadius(22)
            .objectFit(ImageFit.Cover)
        }
        .margin({ left: 12 })

        // Ê†áÈ¢òÂíåÊèèËø∞
        Column() {
          Text(this.currentEpisode?.title || '')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text('Ê≠£Âú®Êí≠Êîæ')
            .fontSize(11)
            .fontColor('#AAAAAA')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12, right: 12 })
        .onClick(() => {
          console.info('======>>> Click: Mini player content');
          this.openPlayerPage();
        })

        // Êí≠Êîæ/ÊöÇÂÅúÊåâÈíÆ
        Button() {
          Text(this.isPlaying ? '‚ùö‚ùö' : '‚ñ∂')
            .fontSize(18)
            .fontColor('#FFFFFF')
        }
        .width(40)
        .height(40)
        .backgroundColor('#FF6B9D')
        .borderRadius(20)
        .onClick(() => {
          console.info(`======>>> Click: Mini player play/pause - isPlaying: ${this.isPlaying}`);
          if (this.isPlaying) {
            this.playerService.pause();
          } else {
            this.playerService.resume();
          }
          this.isPlaying = !this.isPlaying;
        })

        // ‰∏ã‰∏ÄÈ¶ñ/ÂàóË°®ÊåâÈíÆ
        Button() {
          Text('‚ò∞')
            .fontSize(18)
            .fontColor('#FFFFFF')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .margin({ right: 8 })
        .onClick(() => {
          console.info('======>>> Click: Mini player open full player');
          this.openPlayerPage();
        })
      }
      .width('100%')
      .height(64)
      .alignItems(VerticalAlign.Center)
    }
    .width('94%')
    .backgroundColor('#1a1a2e')
    .borderRadius(12)
    .margin({ bottom: 16 })
    .shadow({
      radius: 16,
      color: 'rgba(0, 0, 0, 0.3)',
      offsetX: 0,
      offsetY: 4
    })
    .clip(true)
  }

  /**
   * Á©∫Áä∂ÊÄÅËßÜÂõæ
   */
  @Builder
  buildEmptyView(title: string, message: string) {
    Column() {
      Text('üéß')
        .fontSize(80)
        .opacity(0.3)

      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 20 })

      Text(message)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary_light'))
        .margin({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
