import { Podcast } from '../model/Podcast';
import { Episode } from '../model/Episode';
import { PodcastService } from '../service/PodcastService';
import { DatabaseService } from '../service/DatabaseService';
import { PlayerService } from '../service/PlayerService';
import { router } from '@kit.ArkUI';

@Entry
@Component
struct MainPage {
  @State currentTabIndex: number = 0;
  @State podcasts: Podcast[] = [];
  @State isLoading: boolean = false;
  @State hasCurrentEpisode: boolean = false;
  private playerService: PlayerService = PlayerService.getInstance();

  aboutToAppear() {
    this.loadSubscriptions();
    this.checkCurrentEpisode();
  }

  onPageShow() {
    // é¡µé¢é€šè¿‡è·¯ç”±è¿”å›æ—¶åˆ·æ–°è®¢é˜…åˆ—è¡¨
    this.loadSubscriptions();
    this.checkCurrentEpisode();
  }

  /**
   * åŠ è½½è®¢é˜…åˆ—è¡¨
   */
  async loadSubscriptions() {
    this.isLoading = true;
    try {
      this.podcasts = await PodcastService.getInstance().getSubscribedPodcasts();
    } catch (error) {
      console.error('Failed to load subscriptions:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨æ’­æ”¾çš„å•é›†
   */
  checkCurrentEpisode() {
    const currentEpisode = this.playerService.getCurrentEpisode();
    this.hasCurrentEpisode = currentEpisode !== null;
  }

  /**
   * æ‰“å¼€æ’­æ”¾é¡µé¢
   */
  openPlayerPage() {
    const currentEpisode = this.playerService.getCurrentEpisode();
    if (currentEpisode) {
      router.pushUrl({
        url: 'pages/PlayerPage',
        params: { episodeId: currentEpisode.id }
      }).catch((err: Error) => {
        console.error('Navigation failed:', err);
      });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.buildHeader();

      // Tabé¡µç­¾
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildSubscriptionTab();
        }.tabBar('è®¢é˜…')

        TabContent() {
          this.buildEpisodesTab();
        }.tabBar('å•é›†')

        TabContent() {
          this.buildQueueTab();
        }.tabBar('é˜Ÿåˆ—')

        TabContent() {
          this.buildDownloadsTab();
        }.tabBar('ä¸‹è½½')
      }
      .barMode(BarMode.Fixed)
      .barHeight(56)
      .onChange((index: number) => {
        this.currentTabIndex = index;
      })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_light'))
  }

  /**
   * æ„å»ºå¤´éƒ¨
   */
  @Builder
  buildHeader() {
    Row() {
      Text('AntennaPodHM')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary_light'))

      Blank()

      // æœç´¢æŒ‰é’®
      Button() {
        Text('ğŸ”')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('======>>> Click: Search button');
        // è·³è½¬åˆ°æœç´¢é¡µé¢
        router.pushUrl({ url: 'pages/SearchPage' }).catch((err: Error) => {
          console.error('Navigation failed:', err);
        });
      })

      // è®¾ç½®æŒ‰é’®
      Button() {
        Text('âš™ï¸')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('======>>> Click: Settings button');
        // è·³è½¬åˆ°è®¾ç½®é¡µé¢
        router.pushUrl({ url: 'pages/SettingsPage' }).catch((err: Error) => {
          console.error('Navigation failed:', err);
        });
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
  }

  /**
   * è®¢é˜…é¡µç­¾
   */
  @Builder
  buildSubscriptionTab() {
    Column() {
      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
      } else if (this.podcasts.length === 0) {
        this.buildEmptyView('æš‚æ— è®¢é˜…', 'ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ’­å®¢');
      } else {
        List({ space: 12 }) {
          ForEach(this.podcasts, (podcast: Podcast) => {
            ListItem() {
              this.buildPodcastItem(podcast);
            }
          }, (podcast: Podcast) => podcast.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }

      // æ­£åœ¨æ’­æ”¾æŒ‰é’®
      if (this.hasCurrentEpisode) {
        Button() {
          Row() {
            Text('â–¶')
              .fontSize(20)
              .margin({ right: 8 })
            Text('æ­£åœ¨æ’­æ”¾')
              .fontSize(16)
          }
        }
        .width('90%')
        .height(48)
        .type(ButtonType.Normal)
        .borderRadius(24)
        .backgroundColor('#007AFF')
        .margin({ bottom: 20 })
        .onClick(() => {
          console.info('======>>> Click: Now playing button (Main)');
          this.openPlayerPage();
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * å•é›†é¡µç­¾
   */
  @Builder
  buildEpisodesTab() {
    Column() {
      this.buildEmptyView('æš‚æ— å•é›†', 'è®¢é˜…æ’­å®¢åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ');
    }
    .width('100%')
    .height('100%')
  }

  /**
   * é˜Ÿåˆ—é¡µç­¾
   */
  @Builder
  buildQueueTab() {
    Column() {
      this.buildEmptyView('æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º', 'æ·»åŠ å•é›†åˆ°é˜Ÿåˆ—');
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ä¸‹è½½é¡µç­¾
   */
  @Builder
  buildDownloadsTab() {
    Column() {
      this.buildEmptyView('æš‚æ— ä¸‹è½½', 'ä¸‹è½½å•é›†ä»¥ä¾¿ç¦»çº¿æ”¶å¬');
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ’­å®¢é¡¹
   */
  @Builder
  buildPodcastItem(podcast: Podcast) {
    Row() {
      // æ’­å®¢å°é¢
      Image(podcast.imageUrl)
        .width(80)
        .height(80)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))

      // æ’­å®¢ä¿¡æ¯
      Column() {
        Text(podcast.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(podcast.author)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 4 })

        Text(`${podcast.episodeCount} é›†`)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      console.info(`======>>> Click: Podcast item - ${podcast.title}`);
      // è·³è½¬åˆ°æ’­å®¢è¯¦æƒ…é¡µ
      router.pushUrl({
        url: 'pages/PodcastDetailPage',
        params: { podcastId: podcast.id }
      }).catch((err: Error) => {
        console.error('Navigation failed:', err);
      });
    })
  }

  /**
   * ç©ºçŠ¶æ€è§†å›¾
   */
  @Builder
  buildEmptyView(title: string, message: string) {
    Column() {
      Text('ğŸ§')
        .fontSize(80)
        .opacity(0.3)

      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 20 })

      Text(message)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary_light'))
        .margin({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
