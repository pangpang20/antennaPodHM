import { Podcast } from '../model/Podcast';
import { Episode, DownloadStatus } from '../model/Episode';
import { PodcastService } from '../service/PodcastService';
import { DatabaseService } from '../service/DatabaseService';
import { PlayerService } from '../service/PlayerService';
import { DownloadService } from '../service/DownloadService';
import { router, promptAction } from '@kit.ArkUI';

@Entry
@Component
struct MainPage {
  @State currentTabIndex: number = 0;
  @State podcasts: Podcast[] = [];
  @State isLoading: boolean = false;
  @State hasCurrentEpisode: boolean = false;
  @State currentEpisode: Episode | null = null;
  @State isPlaying: boolean = false;
  @State playProgress: number = 0;
  @State sleepTimerRemaining: number = 0;  // ç¡çœ å®šæ—¶å™¨å‰©ä½™ç§’æ•°
  @State downloadingEpisodes: Episode[] = [];
  @State downloadedEpisodes: Episode[] = [];
  @State allEpisodes: Episode[] = [];  // æ‰€æœ‰å•é›†
  @State episodesPage: number = 1;  // å•é›†å½“å‰é¡µ
  @State episodesPageSize: number = 20;  // æ¯é¡µæ•°é‡
  @State episodesHasMore: boolean = false;  // æ˜¯å¦è¿˜æœ‰æ›´å¤š
  @State queueEpisodes: Episode[] = [];  // å¾…å¬é˜Ÿåˆ—
  private playerService: PlayerService = PlayerService.getInstance();
  private dbService: DatabaseService = DatabaseService.getInstance();
  private downloadUpdateTimer: number = -1;
  private playUpdateTimer: number = -1;
  private subscriptionUpdateTimer: number = -1;

  aboutToAppear() {
    this.loadSubscriptions();
    this.loadAllEpisodes();
    this.loadQueue();
    this.checkCurrentEpisode();
    this.loadDownloads();
    this.startPlayUpdateTimer();
    
    // é»˜è®¤åœ¨è®¢é˜… Tabï¼Œå¯åŠ¨è®¢é˜…åˆ·æ–°å®šæ—¶å™¨
    if (this.currentTabIndex === 0) {
      this.startSubscriptionUpdateTimer();
    }
    
    // ç›‘å¬æ’­æ”¾çŠ¶æ€å˜åŒ–
    this.playerService.addEventListener('stateChange', () => {
      this.checkCurrentEpisode();
    });
  }

  aboutToDisappear() {
    if (this.downloadUpdateTimer !== -1) {
      clearInterval(this.downloadUpdateTimer);
      this.downloadUpdateTimer = -1;
    }
    if (this.playUpdateTimer !== -1) {
      clearInterval(this.playUpdateTimer);
      this.playUpdateTimer = -1;
    }
    if (this.subscriptionUpdateTimer !== -1) {
      clearInterval(this.subscriptionUpdateTimer);
      this.subscriptionUpdateTimer = -1;
    }
  }

  /**
   * å¯åŠ¨æ’­æ”¾çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
   */
  startPlayUpdateTimer() {
    this.playUpdateTimer = setInterval(() => {
      this.checkCurrentEpisode();
    }, 500);
  }

  onPageShow() {
    // é¡µé¢é€šè¿‡è·¯ç”±è¿”å›æ—¶åˆ·æ–°åˆ—è¡¨
    this.loadSubscriptions();
    this.loadAllEpisodes();
    this.loadQueue();
    this.checkCurrentEpisode();
    this.loadDownloads();
  }

  /**
   * åŠ è½½ä¸‹è½½åˆ—è¡¨
   */
  async loadDownloads() {
    try {
      const db = DatabaseService.getInstance();
      const downloadService = DownloadService.getInstance();
      const allEpisodes = await db.getAllEpisodes();
      
      // è·å–æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡ï¼ˆä»å†…å­˜ä¸­è·å–å®æ—¶è¿›åº¦ï¼‰
      const activeTasks = downloadService.getAllDownloadTasks();
      const activeTaskMap = new Map(activeTasks.map(t => [t.episode.id, t.episode]));
      
      // å¯¹äºæ­£åœ¨ä¸‹è½½çš„ï¼Œä¼˜å…ˆä½¿ç”¨å†…å­˜ä¸­çš„å®æ—¶è¿›åº¦
      this.downloadingEpisodes = allEpisodes
        .filter(e => Number(e.downloadStatus) === DownloadStatus.DOWNLOADING)
        .map(e => {
          // å¦‚æœåœ¨æ´»åŠ¨ä¸‹è½½ä¸­ï¼Œä½¿ç”¨å†…å­˜ä¸­çš„è¿›åº¦
          const activeEpisode = activeTaskMap.get(e.id);
          if (activeEpisode) {
            e.downloadProgress = activeEpisode.downloadProgress;
          }
          return e;
        });
      
      this.downloadedEpisodes = allEpisodes.filter(e => {
        const status = Number(e.downloadStatus);
        return status === DownloadStatus.DOWNLOADED;
      });
      
      console.info(`[MainPage] Downloads - Downloading: ${this.downloadingEpisodes.length}, Downloaded: ${this.downloadedEpisodes.length}`);
    } catch (error) {
      console.error('[MainPage] Failed to load downloads:', error);
    }
  }

  /**
   * å¼€å§‹ä¸‹è½½æ›´æ–°å®šæ—¶å™¨
   */
  startDownloadUpdateTimer() {
    if (this.downloadUpdateTimer === -1) {
      this.downloadUpdateTimer = setInterval(() => {
        this.loadDownloads();
      }, 1000);
    }
  }

  /**
   * åœæ­¢ä¸‹è½½æ›´æ–°å®šæ—¶å™¨
   */
  stopDownloadUpdateTimer() {
    if (this.downloadUpdateTimer !== -1) {
      clearInterval(this.downloadUpdateTimer);
      this.downloadUpdateTimer = -1;
    }
  }

  /**
   * å¼€å§‹è®¢é˜…æ›´æ–°å®šæ—¶å™¨ - æ¯5ç§’åˆ·æ–°é›†æ•°
   */
  startSubscriptionUpdateTimer() {
    if (this.subscriptionUpdateTimer === -1) {
      this.subscriptionUpdateTimer = setInterval(() => {
        this.loadSubscriptions();
        console.info('[MainPage] Subscription list refreshed');
      }, 5000);
    }
  }

  /**
   * åœæ­¢è®¢é˜…æ›´æ–°å®šæ—¶å™¨
   */
  stopSubscriptionUpdateTimer() {
    if (this.subscriptionUpdateTimer !== -1) {
      clearInterval(this.subscriptionUpdateTimer);
      this.subscriptionUpdateTimer = -1;
    }
  }

  /**
   * åŠ è½½æ‰€æœ‰å•é›†ï¼ˆå€’åºæ’åˆ—ï¼Œåˆ†é¡µï¼‰
   */
  async loadAllEpisodes() {
    try {
      const allEps = await this.dbService.getAllEpisodes();
      // æŒ‰pubDateå€’åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
      allEps.sort((a, b) => (b.pubDate || 0) - (a.pubDate || 0));
      // åˆ†é¡µæ˜¾ç¤º
      const showCount = this.episodesPage * this.episodesPageSize;
      this.allEpisodes = allEps.slice(0, showCount);
      this.episodesHasMore = allEps.length > showCount;
      console.info(`[MainPage] Loaded ${this.allEpisodes.length}/${allEps.length} episodes (page ${this.episodesPage})`);
    } catch (error) {
      console.error('[MainPage] Failed to load episodes:', error);
    }
  }

  /**
   * åŠ è½½æ›´å¤šå•é›†
   */
  async loadMoreEpisodes() {
    this.episodesPage++;
    await this.loadAllEpisodes();
  }

  /**
   * åŠ è½½å¾…å¬é˜Ÿåˆ—
   */
  async loadQueue() {
    try {
      this.queueEpisodes = await this.dbService.getQueueEpisodes();
      console.info(`[MainPage] Loaded ${this.queueEpisodes.length} queue items`);
    } catch (error) {
      console.error('[MainPage] Failed to load queue:', error);
    }
  }

  /**
   * æ·»åŠ åˆ°å¾…å¬é˜Ÿåˆ—
   */
  async addToQueue(episode: Episode) {
    try {
      await this.dbService.addToQueue(episode.id);
      await this.loadQueue();
      console.info(`[MainPage] Added to queue: ${episode.title}`);
      promptAction.showToast({
        message: 'å·²æ·»åŠ åˆ°é˜Ÿåˆ—',
        duration: 2000
      });
    } catch (error) {
      console.error('[MainPage] Failed to add to queue:', error);
      promptAction.showToast({
        message: 'æ·»åŠ å¤±è´¥',
        duration: 2000
      });
    }
  }

  /**
   * ä»å¾…å¬é˜Ÿåˆ—ç§»é™¤
   */
  async removeFromQueue(episode: Episode) {
    try {
      await this.dbService.removeFromQueue(episode.id);
      await this.loadQueue();
      console.info(`[MainPage] Removed from queue: ${episode.title}`);
    } catch (error) {
      console.error('[MainPage] Failed to remove from queue:', error);
    }
  }

  /**
   * åŠ è½½è®¢é˜…åˆ—è¡¨
   */
  async loadSubscriptions() {
    this.isLoading = true;
    try {
      this.podcasts = await PodcastService.getInstance().getSubscribedPodcasts();
    } catch (error) {
      console.error('Failed to load subscriptions:', error);
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨æ’­æ”¾çš„å•é›†
   */
  checkCurrentEpisode() {
    this.currentEpisode = this.playerService.getCurrentEpisode();
    this.hasCurrentEpisode = this.currentEpisode !== null;
    this.isPlaying = this.playerService.getState() === 'playing';
    
    if (this.currentEpisode) {
      const position = this.playerService.getCurrentPosition();
      const duration = this.playerService.getDuration();
      this.playProgress = duration > 0 ? (position / duration) * 100 : 0;
    }
    
    // æ›´æ–°ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
    this.sleepTimerRemaining = this.playerService.getSleepTimerRemaining();
  }

  /**
   * æ‰“å¼€æ’­æ”¾é¡µé¢
   */
  openPlayerPage() {
    const currentEpisode = this.playerService.getCurrentEpisode();
    if (currentEpisode) {
      router.pushUrl({
        url: 'pages/PlayerPage',
        params: { episodeId: currentEpisode.id }
      }).catch((err: Error) => {
        console.error('Navigation failed:', err);
      });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.buildHeader();

      // Tabé¡µç­¾
      Tabs({ index: this.currentTabIndex }) {
        TabContent() {
          this.buildSubscriptionTab();
        }.tabBar('è®¢é˜…')

        TabContent() {
          this.buildEpisodesTab();
        }.tabBar('å•é›†')

        TabContent() {
          this.buildQueueTab();
        }.tabBar('é˜Ÿåˆ—')

        TabContent() {
          this.buildDownloadsTab();
        }.tabBar('ä¸‹è½½')
      }
      .barMode(BarMode.Fixed)
      .barHeight(56)
      .onChange((index: number) => {
        this.currentTabIndex = index;
        // åˆ‡æ¢åˆ°è®¢é˜… tab æ—¶å¯åŠ¨è®¢é˜…åˆ·æ–°å®šæ—¶å™¨
        if (index === 0) {
          this.loadSubscriptions();
          this.startSubscriptionUpdateTimer();
        } else {
          this.stopSubscriptionUpdateTimer();
        }
        // åˆ‡æ¢åˆ°ä¸‹è½½ tab æ—¶å¯åŠ¨å®šæ—¶åˆ·æ–°
        if (index === 3) {
          this.loadDownloads();
          this.startDownloadUpdateTimer();
        } else {
          this.stopDownloadUpdateTimer();
        }
      })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_light'))
  }

  /**
   * æ„å»ºå¤´éƒ¨
   */
  @Builder
  buildHeader() {
    Row() {
      Text('AntennaPodHM')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary_light'))

      Blank()

      // æœç´¢æŒ‰é’®
      Button() {
        Text('ğŸ”')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('======>>> Click: Search button');
        // è·³è½¬åˆ°æœç´¢é¡µé¢
        router.pushUrl({ url: 'pages/SearchPage' }).catch((err: Error) => {
          console.error('Navigation failed:', err);
        });
      })

      // è®¾ç½®æŒ‰é’®
      Button() {
        Text('âš™ï¸')
          .fontSize(20)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        console.info('======>>> Click: Settings button');
        // è·³è½¬åˆ°è®¾ç½®é¡µé¢
        router.pushUrl({ url: 'pages/SettingsPage' }).catch((err: Error) => {
          console.error('Navigation failed:', err);
        });
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
  }

  /**
   * è®¢é˜…é¡µç­¾
   */
  @Builder
  buildSubscriptionTab() {
    Column() {
      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
      } else if (this.podcasts.length === 0) {
        this.buildEmptyView('æš‚æ— è®¢é˜…', 'ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ’­å®¢');
      } else {
        List({ space: 12 }) {
          ForEach(this.podcasts, (podcast: Podcast) => {
            ListItem() {
              this.buildPodcastItem(podcast);
            }
          }, (podcast: Podcast) => podcast.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }

      // æ­£åœ¨æ’­æ”¾è¿·ä½ æ’­æ”¾å™¨
      if (this.hasCurrentEpisode && this.currentEpisode) {
        this.buildMiniPlayer();
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * å•é›†é¡µç­¾
   */
  @Builder
  buildEpisodesTab() {
    Column() {
      if (this.allEpisodes.length === 0) {
        this.buildEmptyView('æš‚æ— å•é›†', 'è®¢é˜…æ’­å®¢åå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ');
      } else {
        List({ space: 8 }) {
          ForEach(this.allEpisodes, (episode: Episode) => {
            ListItem() {
              this.buildEpisodeItemWithDate(episode);
            }
          }, (episode: Episode) => episode.id)

          // åŠ è½½æ›´å¤šæŒ‰é’®
          if (this.episodesHasMore) {
            ListItem() {
              Row() {
                Button('åŠ è½½æ›´å¤š')
                  .width('100%')
                  .height(44)
                  .fontSize(14)
                  .backgroundColor('#5C6BC0')
                  .fontColor(Color.White)
                  .onClick(() => {
                    console.info('======>>> Click: Load more episodes');
                    this.loadMoreEpisodes();
                  })
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
          }
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }

      // è¿·ä½ æ’­æ”¾å™¨
      if (this.hasCurrentEpisode && this.currentEpisode) {
        this.buildMiniPlayer();
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * å•é›†é¡¹ï¼ˆå¸¦æ—¥æœŸï¼‰
   */
  @Builder
  buildEpisodeItemWithDate(episode: Episode) {
    Row() {
      // å°é¢å›¾
      Image(episode.imageUrl)
        .width(56)
        .height(56)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))

      // å•é›†ä¿¡æ¯
      Column() {
        Text(episode.title)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Row() {
          Text(episode.getFormattedPubDate())
            .fontSize(12)
            .fontColor('#5C6BC0')

          Text(` Â· ${episode.getFormattedDuration()}`)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary_light'))
        }
        .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 12 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      console.info(`======>>> Click: Episode item - ${episode.title}`);
      router.pushUrl({ url: 'pages/EpisodeDetailPage', params: { episode: episode } });
    })
  }

  /**
   * é˜Ÿåˆ—é¡µç­¾
   */
  @Builder
  buildQueueTab() {
    Column() {
      if (this.queueEpisodes.length === 0) {
        this.buildEmptyView('æ’­æ”¾é˜Ÿåˆ—ä¸ºç©º', 'æ·»åŠ å•é›†åˆ°é˜Ÿåˆ—');
      } else {
        // é˜Ÿåˆ—æ“ä½œæ 
        Row() {
          Text(`å¾…å¬ ${this.queueEpisodes.length} é›†`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary_light'))

          Blank()

          Button('æ¸…ç©ºé˜Ÿåˆ—')
            .height(32)
            .fontSize(12)
            .backgroundColor('#FF5252')
            .fontColor(Color.White)
            .onClick(async () => {
              console.info('======>>> Click: Clear queue');
              await this.dbService.clearQueue();
              await this.loadQueue();
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })

        List({ space: 8 }) {
          ForEach(this.queueEpisodes, (episode: Episode, index: number) => {
            ListItem() {
              this.buildQueueItem(episode, index);
            }
          }, (episode: Episode) => episode.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16, bottom: 16 })
      }

      // è¿·ä½ æ’­æ”¾å™¨
      if (this.hasCurrentEpisode && this.currentEpisode) {
        this.buildMiniPlayer();
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * ä¸‹è½½é¡µç­¾
   */
  @Builder
  buildDownloadsTab() {
    Column() {
      // ä¸‹è½½ä¸­éƒ¨åˆ†
      if (this.downloadingEpisodes.length > 0) {
        Text('ä¸‹è½½ä¸­')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 8 })
        
        List({ space: 8 }) {
          ForEach(this.downloadingEpisodes, (episode: Episode) => {
            ListItem() {
              Column() {
                Row() {
                  Text(episode.title)
                    .fontSize(14)
                    .layoutWeight(1)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(`${episode.downloadProgress}%`)
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary_light'))
                }
                .width('100%')

                Progress({ value: episode.downloadProgress, total: 100, type: ProgressType.Linear })
                  .width('100%')
                  .margin({ top: 8 })
              }
              .width('100%')
              .padding(12)
              .backgroundColor(Color.White)
              .borderRadius(8)
            }
          }, (episode: Episode) => `${episode.id}_${episode.downloadProgress}`)
        }
        .width('100%')
        .padding({ left: 16, right: 16 })
      }

      // å·²ä¸‹è½½éƒ¨åˆ†
      if (this.downloadedEpisodes.length > 0) {
        Text('å·²ä¸‹è½½')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .width('100%')
          .padding({ left: 16, top: 12, bottom: 8 })
        
        List({ space: 8 }) {
          ForEach(this.downloadedEpisodes, (episode: Episode) => {
            ListItem() {
              Column() {
                Row() {
                  Column() {
                    Text(episode.title)
                      .fontSize(14)
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })

                    Text(episode.getFormattedFileSize())
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary_light'))
                      .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                }
                .width('100%')

                // æ“ä½œæŒ‰é’®è¡Œ
                Row() {
                  Button('â–¶ æ’­æ”¾')
                    .height(32)
                    .fontSize(12)
                    .backgroundColor('#5C6BC0')
                    .fontColor(Color.White)
                    .onClick(() => {
                      console.info(`======>>> Click: Play downloaded - ${episode.title}`);
                      this.playerService.playEpisode(episode);
                    })

                  Button('+ å¾…å¬')
                    .height(32)
                    .fontSize(12)
                    .margin({ left: 8 })
                    .backgroundColor('#4CAF50')
                    .fontColor(Color.White)
                    .onClick(() => {
                      console.info(`======>>> Click: Add to queue - ${episode.title}`);
                      this.addToQueue(episode);
                    })

                  Blank()

                  Button('åˆ é™¤')
                    .height(32)
                    .fontSize(12)
                    .backgroundColor('#FF5252')
                    .fontColor(Color.White)
                    .onClick(() => {
                      console.info(`======>>> Click: Delete downloaded - ${episode.title}`);
                      DownloadService.getInstance().deleteDownloadedFile(episode);
                      this.loadDownloads();
                    })
                }
                .width('100%')
                .margin({ top: 8 })
              }
              .width('100%')
              .padding(12)
              .backgroundColor(Color.White)
              .borderRadius(8)
            }
          }, (episode: Episode) => episode.id)
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
      }

      // ç©ºçŠ¶æ€
      if (this.downloadingEpisodes.length === 0 && this.downloadedEpisodes.length === 0) {
        this.buildEmptyView('æš‚æ— ä¸‹è½½', 'ä¸‹è½½å•é›†ä»¥ä¾¿ç¦»çº¿æ”¶å¬');
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æ’­å®¢é¡¹
   */
  @Builder
  buildPodcastItem(podcast: Podcast) {
    Row() {
      // æ’­å®¢å°é¢
      Image(podcast.imageUrl)
        .width(80)
        .height(80)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))

      // æ’­å®¢ä¿¡æ¯
      Column() {
        Text(podcast.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(podcast.author)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 4 })

        Text(`${podcast.episodeCount} é›†`)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 12 })
      .layoutWeight(1)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .onClick(() => {
      console.info(`======>>> Click: Podcast item - ${podcast.title}`);
      // è·³è½¬åˆ°æ’­å®¢è¯¦æƒ…é¡µ
      router.pushUrl({
        url: 'pages/PodcastDetailPage',
        params: { podcastId: podcast.id }
      }).catch((err: Error) => {
        console.error('Navigation failed:', err);
      });
    })
  }

  /**
   * å•é›†é¡¹
   */
  @Builder
  buildEpisodeItem(episode: Episode) {
    Column() {
      Row() {
        // å°é¢å›¾
        Image(episode.imageUrl)
          .width(60)
          .height(60)
          .borderRadius(6)
          .objectFit(ImageFit.Cover)
          .alt($r('app.media.app_icon'))

        // å•é›†ä¿¡æ¯
        Column() {
          Text(episode.title)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Row() {
            Text(episode.getFormattedDuration())
              .fontSize(12)
              .fontColor($r('app.color.text_secondary_light'))

            if (episode.downloadStatus === 2) {
              Text(' Â· å·²ä¸‹è½½')
                .fontSize(12)
                .fontColor('#4CAF50')
            }
          }
          .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12 })
      }
      .width('100%')

      // æ“ä½œæŒ‰é’®
      Row() {
        Button('â–¶ æ’­æ”¾')
          .height(28)
          .fontSize(11)
          .backgroundColor('#5C6BC0')
          .fontColor(Color.White)
          .onClick(() => {
            console.info(`======>>> Click: Play episode - ${episode.title}`);
            this.playerService.playEpisode(episode);
          })

        Button('+ å¾…å¬')
          .height(28)
          .fontSize(11)
          .margin({ left: 8 })
          .backgroundColor('#4CAF50')
          .fontColor(Color.White)
          .onClick(() => {
            console.info(`======>>> Click: Add to queue - ${episode.title}`);
            this.addToQueue(episode);
          })
      }
      .width('100%')
      .margin({ top: 8 })
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Color.White)
    .borderRadius(8)
  }

  /**
   * é˜Ÿåˆ—é¡¹
   */
  @Builder
  buildQueueItem(episode: Episode, index: number) {
    Row() {
      // åºå·
      Text(`${index + 1}`)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#5C6BC0')
        .width(28)
        .textAlign(TextAlign.Center)

      // å°é¢å›¾
      Image(episode.imageUrl)
        .width(46)
        .height(46)
        .borderRadius(6)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))
        .margin({ left: 4 })

      // å•é›†ä¿¡æ¯
      Column() {
        Text(episode.title)
          .fontSize(13)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(episode.getFormattedDuration())
          .fontSize(11)
          .fontColor($r('app.color.text_secondary_light'))
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      .margin({ left: 8, right: 8 })

      // æ“ä½œæŒ‰é’®
      Button('â–¶')
        .width(34)
        .height(34)
        .fontSize(12)
        .backgroundColor('#5C6BC0')
        .fontColor(Color.White)
        .borderRadius(17)
        .flexShrink(0)
        .onClick(() => {
          console.info(`======>>> Click: Play from queue - ${episode.title}`);
          this.playerService.playEpisode(episode);
        })

      Button('Ã—')
        .width(28)
        .height(28)
        .fontSize(14)
        .backgroundColor(Color.Transparent)
        .fontColor('#999999')
        .margin({ left: 4, right: 4 })
        .flexShrink(0)
        .onClick(() => {
          console.info(`======>>> Click: Remove from queue - ${episode.title}`);
          this.removeFromQueue(episode);
        })
    }
    .width('100%')
    .padding(8)
    .backgroundColor(Color.White)
    .borderRadius(8)
  }

  /**
   * æ„å»ºè¿·ä½ æ’­æ”¾å™¨ - QQéŸ³ä¹é£æ ¼
   */
  @Builder
  buildMiniPlayer() {
    Column() {
      // è¿›åº¦æ¡
      Row() {
        Progress({ value: this.playProgress, total: 100, type: ProgressType.Linear })
          .width('100%')
          .height(2)
          .color('#5C6BC0')
          .backgroundColor('#E0E0E0')
      }
      .width('100%')

      // æ’­æ”¾å™¨å†…å®¹
      Row() {
        // å°é¢å›¾ï¼ˆå¸¦æ—‹è½¬æ•ˆæœçš„è®¾è®¡ï¼‰
        Stack() {
          // åœ†å½¢èƒŒæ™¯
          Circle()
            .width(50)
            .height(50)
            .fill('#1a1a2e')
          
          // å°é¢å›¾
          Image(this.currentEpisode?.imageUrl || '')
            .width(44)
            .height(44)
            .borderRadius(22)
            .objectFit(ImageFit.Cover)
        }
        .margin({ left: 12 })

        // æ ‡é¢˜å’Œæè¿°
        Column() {
          Marquee({
            start: this.isPlaying,
            step: 3,
            loop: -1,
            fromStart: true,
            src: this.currentEpisode?.title || ''
          })
            .width('100%')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')

          Row() {
            Text('æ­£åœ¨æ’­æ”¾')
              .fontSize(11)
              .fontColor('#AAAAAA')
            
            // ç¡çœ å®šæ—¶å™¨å€’è®¡æ—¶
            if (this.sleepTimerRemaining > 0) {
              Text(' Â· ')
                .fontSize(11)
                .fontColor('#AAAAAA')
              Text(`â° ${this.formatSleepTimer(this.sleepTimerRemaining)}`)
                .fontSize(11)
                .fontColor('#5C6BC0')
                .fontWeight(FontWeight.Medium)
            }
          }
          .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 12, right: 12 })
        .onClick(() => {
          console.info('======>>> Click: Mini player content');
          this.openPlayerPage();
        })

        // æ’­æ”¾/æš‚åœæŒ‰é’®
        Button() {
          Text(this.isPlaying ? 'âšâš' : 'â–¶')
            .fontSize(18)
            .fontColor('#FFFFFF')
        }
        .width(40)
        .height(40)
        .backgroundColor('#5C6BC0')
        .borderRadius(20)
        .onClick(() => {
          console.info(`======>>> Click: Mini player play/pause - isPlaying: ${this.isPlaying}`);
          if (this.isPlaying) {
            this.playerService.pause();
          } else {
            this.playerService.resume();
          }
          this.isPlaying = !this.isPlaying;
        })

        // ä¸‹ä¸€é¦–/åˆ—è¡¨æŒ‰é’®
        Button() {
          Text('â˜°')
            .fontSize(18)
            .fontColor('#FFFFFF')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .margin({ right: 8 })
        .onClick(() => {
          console.info('======>>> Click: Mini player open full player');
          this.openPlayerPage();
        })
      }
      .width('100%')
      .height(64)
      .alignItems(VerticalAlign.Center)
    }
    .width('94%')
    .backgroundColor('#1a1a2e')
    .borderRadius(12)
    .margin({ bottom: 16 })
    .shadow({
      radius: 16,
      color: 'rgba(0, 0, 0, 0.3)',
      offsetX: 0,
      offsetY: 4
    })
    .clip(true)
  }

  /**
   * æ ¼å¼åŒ–ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
   */
  formatSleepTimer(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins > 0) {
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${secs}s`;
    }
  }

  /**
   * ç©ºçŠ¶æ€è§†å›¾
   */
  @Builder
  buildEmptyView(title: string, message: string) {
    Column() {
      Text('ğŸ§')
        .fontSize(80)
        .opacity(0.3)

      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ top: 20 })

      Text(message)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary_light'))
        .margin({ top: 8 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
