import { router, promptAction } from '@kit.ArkUI';
import { Episode } from '../model/Episode';
import { PlayerService, PlayerState } from '../service/PlayerService';
import { SettingsService } from '../service/SettingsService';
import { Constants } from '../common/Constants';
import { DatabaseService } from '../service/DatabaseService';
import { DownloadService } from '../service/DownloadService';

@Entry
@Component
struct PlayerPage {
  @State currentEpisode: Episode | null = null;
  @State playerState: PlayerState = PlayerState.IDLE;
  @State currentPosition: number = 0;
  @State duration: number = 0;
  @State playbackSpeed: number = 1.0;
  @State showSpeedSelector: boolean = false;
  @State sleepTimerMinutes: number = 0;
  @State sleepTimerRemaining: number = 0;  // å‰©ä½™ç§’æ•°
  @State marqueeText: string = '';  // è·‘é©¬ç¯æ–‡æœ¬
  
  private playerService: PlayerService = PlayerService.getInstance();
  private updateTimer: number = -1;

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['episodeId']) {
      const episodeId = params['episodeId'] as string;
      this.loadEpisode(episodeId);
    }

    // åŠ è½½é»˜è®¤æ’­æ”¾é€Ÿåº¦
    const settingsService = SettingsService.getInstance();
    this.playbackSpeed = settingsService.getPlaybackSpeed();

    // ç›‘å¬æ’­æ”¾å™¨çŠ¶æ€
    this.playerService.addEventListener('stateChange', (state: PlayerState) => {
      this.playerState = state;
    });

    this.playerService.addEventListener('timeUpdate', (time: number) => {
      // ç§»é™¤é¢‘ç¹çš„æ—¥å¿—è¾“å‡º
      this.currentPosition = time;
    });

    // ç›‘å¬æ—¶é•¿æ›´æ–°
    this.playerService.addEventListener('durationUpdate', (duration: number) => {
      console.info(`[PlayerPage] durationUpdate event received: ${duration}s`);
      this.duration = duration;
    });

    // ç›‘å¬ç¡çœ å®šæ—¶å™¨ç»“æŸ
    this.playerService.addEventListener('sleepTimerEnd', () => {
      this.sleepTimerMinutes = 0;
      promptAction.showToast({ message: 'å®šæ—¶æ’­æ”¾ç»“æŸï¼Œå·²æš‚åœ', duration: 2000 });
    });

    // å¯åŠ¨å®šæ—¶å™¨æ›´æ–°è¿›åº¦
    this.startUpdateTimer();

    // åŒæ­¥ç¡çœ å®šæ—¶å™¨çŠ¶æ€
    this.sleepTimerMinutes = this.playerService.getSleepTimerMinutes();
  }

  aboutToDisappear() {
    if (this.updateTimer !== -1) {
      clearInterval(this.updateTimer);
    }
    // ä¸å†æ¸…é™¤ç¡çœ å®šæ—¶å™¨ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨ PlayerService ä¸­ç®¡ç†
  }

  async loadEpisode(episodeId: string) {
    try {
      const db = DatabaseService.getInstance();
      const episode = await db.getEpisodeById(episodeId);
      if (!episode) {
        console.warn('Episode not found for id:', episodeId);
        return;
      }

      console.info('[PlayerPage] Episode loaded:', episode.title);
      console.info('[PlayerPage] audioUrl:', episode.audioUrl);
      console.info('[PlayerPage] localPath:', episode.localPath);
      console.info('[PlayerPage] duration:', episode.duration);

      // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢æ’­æ”¾
      const currentPlaying = this.playerService.getCurrentEpisode();
      const needToPlay = !currentPlaying || currentPlaying.id !== episode.id;

      this.currentEpisode = episode;
      this.currentPosition = episode.playbackPosition;
      this.duration = episode.duration;
      
      // æ›´æ–°è·‘é©¬ç¯æ–‡æœ¬
      this.marqueeText = `${episode.title}     â—†     `;

      // å¦‚æœæ˜¯æ–°çš„ episodeï¼Œè‡ªåŠ¨å¼€å§‹æ’­æ”¾
      if (needToPlay) {
        console.info('[PlayerPage] Starting playback for new episode');
        await this.playerService.playEpisode(episode);
      } else {
        // åŒæ­¥å½“å‰æ’­æ”¾çŠ¶æ€
        this.playerState = this.playerService.getState();
        this.currentPosition = this.playerService.getCurrentPosition();
        this.duration = this.playerService.getDuration();
      }
    } catch (error) {
      console.error('Failed to load episode:', error);
    }
  }

  startUpdateTimer() {
    this.updateTimer = setInterval(() => {
      if (this.playerState === PlayerState.PLAYING) {
        const newPosition = this.playerService.getCurrentPosition();
        const newDuration = this.playerService.getDuration();
        this.currentPosition = newPosition;
        this.duration = newDuration;
      }
      
      // æ›´æ–°ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
      this.sleepTimerRemaining = this.playerService.getSleepTimerRemaining();
      if (this.sleepTimerRemaining <= 0) {
        this.sleepTimerMinutes = 0;
      }
    }, 1000);
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      this.buildNavigationBar();

      Scroll() {
        Column() {
          // Episodeä¿¡æ¯
          this.buildEpisodeInfo();

          // è¿›åº¦æ¡
          this.buildProgressBar();

          // æ’­æ”¾æ§åˆ¶
          this.buildPlaybackControls();

          // åŠŸèƒ½æŒ‰é’®
          this.buildFunctionButtons();
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .linearGradient({
      angle: 135,
      colors: [['#f5f7fa', 0.0], ['#e8edf3', 0.5], ['#dce3ec', 1.0]]
    })
  }

  @Builder
  buildNavigationBar() {
    Row() {
      Button() {
        Text('â†')
          .fontSize(22)
          .fontColor('#333333')
      }
      .width(44)
      .height(44)
      .backgroundColor('rgba(255, 255, 255, 0.9)')
      .borderRadius(22)
      .onClick(() => {
        console.info('======>>> Click: Back button (Player)');
        router.back();
      })

      Blank()

      // æ›´å¤šæ“ä½œæŒ‰é’®
      Button() {
        Text('â‹®')
          .fontSize(22)
          .fontColor('#333333')
      }
      .width(44)
      .height(44)
      .backgroundColor('rgba(255, 255, 255, 0.9)')
      .borderRadius(22)
      .onClick(() => {
        console.info('======>>> Click: More options');
        this.showMoreOptionsMenu();
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  buildEpisodeInfo() {
    Column() {
      // å°é¢å›¾ - æ›´å¤§ï¼Œå¸¦é˜´å½±
      Image(this.currentEpisode?.imageUrl)
        .width(280)
        .height(280)
        .borderRadius(16)
        .objectFit(ImageFit.Cover)
        .margin({ top: 20 })
        .shadow({
          radius: 30,
          color: 'rgba(0, 0, 0, 0.25)',
          offsetX: 0,
          offsetY: 10
        })

      // æ ‡é¢˜ - ä½¿ç”¨è·‘é©¬ç¯
      Marquee({
        start: this.playerState === PlayerState.PLAYING,
        step: 4,
        loop: -1,
        fromStart: true,
        src: this.marqueeText || this.currentEpisode?.title || ''
      })
        .width('85%')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1a1a1a')
        .margin({ top: 20 })
        .allowScale(false)

      // æè¿°
      Text(this.currentEpisode?.description || '')
        .fontSize(13)
        .fontColor('#666666')
        .margin({ top: 8 })
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('85%')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
  }

  @Builder
  buildProgressBar() {
    Column() {
      // æ—¶é—´æ˜¾ç¤º
      Row() {
        Text(this.formatTime(this.currentPosition))
          .fontSize(13)
          .fontColor('#666666')
          .fontWeight(FontWeight.Medium)

        Blank()

        Text(this.formatTime(this.duration))
          .fontSize(13)
          .fontColor('#666666')
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // è¿›åº¦æ¡
      Slider({
        value: this.currentPosition,
        min: 0,
        max: this.duration,
        style: SliderStyle.OutSet
      })
        .width('100%')
        .trackColor('#E0E0E0')
        .selectedColor('#5C6BC0')
        .trackThickness(4)
        .onChange((value: number) => {
          this.playerService.seek(value);
        })
    }
    .width('100%')
    .padding({ left: 32, right: 32, top: 25 })
  }

  @Builder
  buildPlaybackControls() {
    Row() {
      // åé€€15ç§’
      Column() {
        Button() {
          Text('âª')
            .fontSize(24)
            .fontColor('#5C6BC0')
        }
        .width(56)
        .height(56)
        .backgroundColor('rgba(92, 107, 192, 0.1)')
        .borderRadius(28)
        .onClick(() => {
          console.info('======>>> Click: Rewind 15s');
          const newPosition = Math.max(0, this.currentPosition - 15);
          this.playerService.seek(newPosition);
          promptAction.showToast({
            message: 'å¿«é€€ 15 ç§’',
            duration: 1000
          });
        })
        
        Text('15ç§’')
          .fontSize(11)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
  
      Blank()
  
      // æ’­æ”¾/æš‚åœæŒ‰é’® - æ›´å¤§ã€æ›´çªå‡º
      Button() {
        Text(this.playerState === PlayerState.PLAYING ? 'â¸' : 'â–¶')
          .fontSize(38)
          .fontColor(Color.White)
      }
      .width(72)
      .height(72)
      .backgroundColor('#5C6BC0')
      .borderRadius(36)
      .shadow({
        radius: 12,
        color: 'rgba(92, 107, 192, 0.4)',
        offsetX: 0,
        offsetY: 4
      })
      .onClick(() => {
        console.info(`======>>> Click: Play/Pause - state: ${this.playerState}`);
        if (this.playerState === PlayerState.PLAYING) {
          this.playerService.pause();
        } else if (this.playerState === PlayerState.PAUSED) {
          this.playerService.resume();
        } else if (this.currentEpisode) {
          this.playerService.playEpisode(this.currentEpisode);
        }
      })
  
      Blank()
  
      // å‰è¿›30ç§’
      Column() {
        Button() {
          Text('â©')
            .fontSize(24)
            .fontColor('#5C6BC0')
        }
        .width(56)
        .height(56)
        .backgroundColor('rgba(92, 107, 192, 0.1)')
        .borderRadius(28)
        .onClick(() => {
          console.info('======>>> Click: Forward 30s');
          const newPosition = Math.min(this.duration, this.currentPosition + 30);
          this.playerService.seek(newPosition);
          promptAction.showToast({
            message: 'å¿«è¿› 30 ç§’',
            duration: 1000
          });
        })
        
        Text('30ç§’')
          .fontSize(11)
          .fontColor('#999999')
          .margin({ top: 4 })
      }
    }
    .width('100%')
    .padding({ left: 50, right: 50, top: 20 })
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildFunctionButtons() {
    Column() {
      // ç¬¬ä¸€è¡Œï¼šæ’­æ”¾é€Ÿåº¦ã€å®šæ—¶å…³é—­
      Row() {
        // æ’­æ”¾é€Ÿåº¦
        Button() {
          Row() {
            Text('ğŸš€')
              .fontSize(16)
              .margin({ right: 6 })
            Text(`${this.playbackSpeed}x`)
              .fontSize(14)
              .fontColor('#5C6BC0')
              .fontWeight(FontWeight.Medium)
          }
        }
        .height(40)
        .padding({ left: 16, right: 16 })
        .backgroundColor('rgba(92, 107, 192, 0.08)')
        .borderRadius(20)
        .border({ width: 1, color: 'rgba(92, 107, 192, 0.2)', radius: 20 })
        .onClick(() => {
          console.info('======>>> Click: Playback speed selector');
          this.showSpeedSelectorMenu();
        })

        Blank()

        // ç¡çœ å®šæ—¶å™¨
        Button() {
          Row() {
            Text('â°')
              .fontSize(16)
              .margin({ right: 6 })
            if (this.sleepTimerRemaining > 0) {
              Text(this.formatSleepTimer(this.sleepTimerRemaining))
                .fontSize(14)
                .fontColor('#FF6B6B')
                .fontWeight(FontWeight.Medium)
            } else {
              Text('å®šæ—¶')
                .fontSize(14)
                .fontColor('#666666')
            }
          }
        }
        .height(40)
        .padding({ left: 16, right: 16 })
        .backgroundColor(this.sleepTimerRemaining > 0 ? 'rgba(255, 107, 107, 0.08)' : 'rgba(0, 0, 0, 0.05)')
        .borderRadius(20)
        .border({ 
          width: 1, 
          color: this.sleepTimerRemaining > 0 ? 'rgba(255, 107, 107, 0.3)' : 'rgba(0, 0, 0, 0.1)', 
          radius: 20 
        })
        .onClick(() => {
          console.info('======>>> Click: Sleep timer');
          this.showSleepTimerMenu();
        })
      }
      .width('100%')
      .margin({ top: 20 })

      // ç¬¬äºŒè¡Œï¼šæ·»åŠ åˆ°é˜Ÿåˆ—
      Button() {
        Row() {
          Text('â•')
            .fontSize(16)
            .margin({ right: 6 })
          Text('æ·»åŠ åˆ°é˜Ÿåˆ—')
            .fontSize(14)
            .fontColor('#666666')
        }
      }
      .width('100%')
      .height(44)
      .backgroundColor('rgba(0, 0, 0, 0.05)')
      .borderRadius(22)
      .border({ width: 1, color: 'rgba(0, 0, 0, 0.1)', radius: 22 })
      .margin({ top: 12 })
      .onClick(() => {
        console.info(`======>>> Click: Add to queue - ${this.currentEpisode?.title || 'no episode'}`);
        if (!this.currentEpisode) {
          console.warn('No current episode to add to queue');
          return;
        }
        this.playerService.addToQueue(this.currentEpisode);
        promptAction.showToast({ message: 'å·²æ·»åŠ åˆ°é˜Ÿåˆ—', duration: 2000 });
      })
    }
    .width('100%')
    .padding({ left: 32, right: 32, bottom: 20 })
  }

  /**
   * æ ¼å¼åŒ–ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
   */
  formatSleepTimer(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins > 0) {
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${secs}s`;
    }
  }

  showSpeedSelectorMenu(): void {
    promptAction.showActionMenu({
      title: 'é€‰æ‹©æ’­æ”¾é€Ÿåº¦',
      buttons: [
        { text: '0.75x', color: '#000000' },
        { text: '1.0x', color: '#000000' },
        { text: '1.25x', color: '#000000' },
        { text: '1.5x', color: '#000000' },
        { text: '2.0x', color: '#000000' },
        { text: '2.5x', color: '#000000' }
      ]
    }).then((result: promptAction.ActionMenuSuccessResponse) => {
      const speeds: number[] = [0.75, 1.0, 1.25, 1.5, 2.0, 2.5];
      const selectedSpeed = speeds[result.index];
      this.playbackSpeed = selectedSpeed;
      this.playerService.setPlaybackSpeed(selectedSpeed);
    }).catch((err: Error) => {
      console.info('Speed selection cancelled');
    });
  }

  showSleepTimerMenu(): void {
    promptAction.showActionMenu({
      title: 'å®šæ—¶å…³é—­',
      buttons: [
        { text: 'å…³é—­å®šæ—¶', color: '#000000' },
        { text: '5 åˆ†é’Ÿ', color: '#000000' },
        { text: '15 åˆ†é’Ÿ', color: '#000000' },
        { text: '30 åˆ†é’Ÿ', color: '#000000' },
        { text: '45 åˆ†é’Ÿ', color: '#000000' },
        { text: '60 åˆ†é’Ÿ', color: '#000000' }
      ]
    }).then((result: promptAction.ActionMenuSuccessResponse) => {
      const minutesOptions: number[] = [0, 5, 15, 30, 45, 60];
      const minutes = minutesOptions[result.index];
      this.sleepTimerMinutes = minutes;
      this.playerService.setSleepTimer(minutes);
      const msg = minutes > 0 ? `å·²è®¾ç½®å®šæ—¶å…³é—­ï¼š${minutes} åˆ†é’Ÿ` : 'å·²å…³é—­å®šæ—¶æ’­æ”¾';
      promptAction.showToast({ message: msg, duration: 2000 });
    }).catch((err: Error) => {
      console.info('Sleep timer selection cancelled');
    });
  }

  formatTime(seconds: number): string {
    const totalSeconds = Math.floor(seconds);
    const minutes = Math.floor(totalSeconds / 60);
    const hours = Math.floor(minutes / 60);
    const remainingSeconds = totalSeconds % 60;

    if (hours > 0) {
      return `${hours}:${(minutes % 60).toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    } else {
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
  }

  /**
   * åˆ†äº«å•é›†
   */
  shareEpisode(): void {
    if (!this.currentEpisode) {
      return;
    }

    const shareText = `æˆ‘æ­£åœ¨å¬ã€Š${this.currentEpisode.title}ã€‹

${this.currentEpisode.description}

åˆ†äº«è‡ª AntennaPodHM`;
    
    promptAction.showActionMenu({
      title: 'åˆ†äº«åˆ°',
      buttons: [
        { text: 'å¾®ä¿¡å¥½å‹', color: '#000000' },
        { text: 'å¾®ä¿¡æœ‹å‹åœˆ', color: '#000000' },
        { text: 'å¤åˆ¶é“¾æ¥', color: '#000000' },
        { text: 'æ›´å¤šåˆ†äº«æ–¹å¼', color: '#000000' }
      ]
    }).then((result: promptAction.ActionMenuSuccessResponse) => {
      switch (result.index) {
        case 0:
          // åˆ†äº«åˆ°å¾®ä¿¡å¥½å‹
          this.shareToWeChatFriend();
          break;
        case 1:
          // åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ
          this.shareToWeChatMoments();
          break;
        case 2:
          // å¤åˆ¶é“¾æ¥
          this.copyShareLink();
          break;
        case 3:
          // ç³»ç»Ÿåˆ†äº«
          this.systemShare();
          break;
      }
    }).catch((err: Error) => {
      console.info('Share menu cancelled');
    });
  }

  /**
   * åˆ†äº«åˆ°å¾®ä¿¡å¥½å‹
   */
  shareToWeChatFriend(): void {
    // TODO: é›†æˆå¾®ä¿¡ SDK åå®ç°
    // ç›®å‰æ˜¾ç¤ºæç¤ºï¼Œåç»­é›†æˆå¾®ä¿¡åˆ†äº« SDK
    promptAction.showToast({
      message: 'å³å°†æ‰“å¼€å¾®ä¿¡åˆ†äº«',
      duration: 2000
    });
    console.info('[PlayerPage] Share to WeChat friend:', this.currentEpisode?.title);
  }

  /**
   * åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ
   */
  shareToWeChatMoments(): void {
    // TODO: é›†æˆå¾®ä¿¡ SDK åå®ç°
    promptAction.showToast({
      message: 'å³å°†æ‰“å¼€æœ‹å‹åœˆåˆ†äº«',
      duration: 2000
    });
    console.info('[PlayerPage] Share to WeChat moments:', this.currentEpisode?.title);
  }

  /**
   * å¤åˆ¶åˆ†äº«é“¾æ¥
   */
  copyShareLink(): void {
    if (!this.currentEpisode) {
      return;
    }
    
    const shareLink = `antennaPod://episode/${this.currentEpisode.id}`;
    const shareText = `ã€Š${this.currentEpisode.title}ã€‹\n${shareLink}`;
    
    // ä½¿ç”¨ç³»ç»Ÿå‰ªè´´æ¿ APIï¼ˆéœ€è¦æ·»åŠ æƒé™ï¼‰
    // TODO: æ·»åŠ å‰ªè´´æ¿æƒé™åå®ç°
    promptAction.showToast({
      message: 'é“¾æ¥å·²å¤åˆ¶',
      duration: 2000
    });
    console.info('[PlayerPage] Copy share link:', shareText);
  }

  /**
   * ç³»ç»Ÿåˆ†äº«
   */
  systemShare(): void {
    if (!this.currentEpisode) {
      return;
    }
    
    const shareText = `æˆ‘æ­£åœ¨å¬ã€Š${this.currentEpisode.title}ã€‹

${this.currentEpisode.description}

åˆ†äº«è‡ª AntennaPodHM`;
    
    // TODO: ä½¿ç”¨ HarmonyOS ç³»ç»Ÿåˆ†äº« API
    promptAction.showToast({
      message: 'æ‰“å¼€ç³»ç»Ÿåˆ†äº«é¢æ¿',
      duration: 2000
    });
    console.info('[PlayerPage] System share:', shareText);
  }

  /**
   * æ˜¾ç¤ºæ›´å¤šé€‰é¡¹èœå•
   */
  showMoreOptionsMenu(): void {
    promptAction.showActionMenu({
      title: 'æ›´å¤šé€‰é¡¹',
      buttons: [
        { text: 'æŸ¥çœ‹å•é›†è¯¦æƒ…', color: '#000000' },
        { text: 'åˆ†äº«è¿™ä¸€é›†', color: '#000000' },
        { text: 'ä¸‹è½½åˆ°æœ¬åœ°', color: '#000000' }
      ]
    }).then((result: promptAction.ActionMenuSuccessResponse) => {
      switch (result.index) {
        case 0:
          // æŸ¥çœ‹å•é›†è¯¦æƒ…
          if (this.currentEpisode) {
            router.pushUrl({
              url: 'pages/EpisodeDetailPage',
              params: { episodeId: this.currentEpisode.id }
            }).catch((err: Error) => {
              console.error('Navigation failed:', err);
            });
          }
          break;
        case 1:
          // åˆ†äº«
          if (this.currentEpisode) {
            this.shareEpisode();
          } else {
            promptAction.showToast({ 
              message: 'æš‚æ— å¯åˆ†äº«çš„å†…å®¹', 
              duration: 2000 
            });
          }
          break;
        case 2:
          // ä¸‹è½½
          if (this.currentEpisode) {
            DownloadService.getInstance().downloadEpisode(this.currentEpisode)
              .then(() => {
                promptAction.showToast({ 
                  message: 'å·²æ·»åŠ åˆ°ä¸‹è½½é˜Ÿåˆ—', 
                  duration: 2000 
                });
              })
              .catch((err: Error) => {
                console.error('Download failed:', err);
                promptAction.showToast({ 
                  message: 'ä¸‹è½½å¤±è´¥', 
                  duration: 2000 
                });
              });
          }
          break;
      }
    }).catch((err: Error) => {
      console.info('More options menu cancelled');
    });
  }
}
