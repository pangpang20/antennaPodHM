import { UIUtils, ToastOptions, DialogOptions, ActionMenuOptions, ButtonOptions, RouteParams } from '../common/UIUtils';
import { Episode } from '../model/Episode';
import { PlayerService, PlayerState } from '../service/PlayerService';
import { SettingsService } from '../service/SettingsService';
import { Constants } from '../common/Constants';
import { DatabaseService } from '../service/DatabaseService';
import { DownloadService } from '../service/DownloadService';
import { pasteboard } from '@kit.BasicServicesKit';
import { BusinessError } from '@kit.BasicServicesKit';

@Entry
@Component
struct PlayerPage {
  @State currentEpisode: Episode | null = null;
  @State playerState: PlayerState = PlayerState.IDLE;
  @State currentPosition: number = 0;
  @State duration: number = 0;
  @State playbackSpeed: number = 1.0;
  @State showSpeedSelector: boolean = false;
  @State sleepTimerMinutes: number = 0;
  @State sleepTimerRemaining: number = 0;  // å‰©ä½™ç§’æ•°
  @State marqueeText: string = '';  // è·‘é©¬ç¯æ–‡æœ¬
  @State showDescriptionDialog: boolean = false;  // æ˜¾ç¤ºç®€ä»‹å¼¹çª—
  
  private playerService: PlayerService = PlayerService.getInstance();
  private updateTimer: number = -1;

  aboutToAppear() {
    const params = UIUtils.getParams<Record<string, Object>>();
    if (params && params['episodeId']) {
      const episodeId = params['episodeId'] as string;
      this.loadEpisode(episodeId);
    }

    // ä» PlayerService åŒæ­¥å½“å‰æ’­æ”¾é€Ÿåº¦ï¼Œç¡®ä¿ä¸€è‡´æ€§
    this.playbackSpeed = this.playerService.getPlaybackSpeed();
    console.info(`[PlayerPage] Synced playback speed from PlayerService: ${this.playbackSpeed}`);

    // ç›‘å¬æ’­æ”¾å™¨çŠ¶æ€
    this.playerService.addEventListener('stateChange', (state: PlayerState) => {
      this.playerState = state;
    });

    this.playerService.addEventListener('timeUpdate', (time: number) => {
      // ç§»é™¤é¢‘ç¹çš„æ—¥å¿—è¾“å‡º
      this.currentPosition = time;
    });

    // ç›‘å¬æ—¶é•¿æ›´æ–°
    this.playerService.addEventListener('durationUpdate', (duration: number) => {
      console.info(`[PlayerPage] durationUpdate event received: ${duration}s`);
      this.duration = duration;
    });

    // ç›‘å¬ç¡çœ å®šæ—¶å™¨ç»“æŸ
    this.playerService.addEventListener('sleepTimerEnd', () => {
      this.sleepTimerMinutes = 0;
      UIUtils.showToast(new ToastOptions('å®šæ—¶æ’­æ”¾ç»“æŸï¼Œå·²æš‚åœ', 2000));
    });

    // å¯åŠ¨å®šæ—¶å™¨æ›´æ–°è¿›åº¦
    this.startUpdateTimer();

    // åŒæ­¥ç¡çœ å®šæ—¶å™¨çŠ¶æ€
    this.sleepTimerMinutes = this.playerService.getSleepTimerMinutes();
  }

  aboutToDisappear() {
    if (this.updateTimer !== -1) {
      clearInterval(this.updateTimer);
    }
    // ä¸å†æ¸…é™¤ç¡çœ å®šæ—¶å™¨ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨ PlayerService ä¸­ç®¡ç†
  }

  async loadEpisode(episodeId: string) {
    try {
      const db = DatabaseService.getInstance();
      const episode = await db.getEpisodeById(episodeId);
      if (!episode) {
        console.warn('Episode not found for id:', episodeId);
        return;
      }

      console.info('[PlayerPage] Episode loaded:', episode.title);
      console.info('[PlayerPage] audioUrl:', episode.audioUrl);
      console.info('[PlayerPage] localPath:', episode.localPath);
      console.info('[PlayerPage] duration:', episode.duration);

      // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢æ’­æ”¾
      const currentPlaying = this.playerService.getCurrentEpisode();
      const needToPlay = !currentPlaying || currentPlaying.id !== episode.id;

      this.currentEpisode = episode;
      this.currentPosition = episode.playbackPosition;
      this.duration = episode.duration;
      
      // æ›´æ–°è·‘é©¬ç¯æ–‡æœ¬
      this.marqueeText = `${episode.title}     â—†     `;

      // å¦‚æœæ˜¯æ–°çš„ episodeï¼Œè‡ªåŠ¨å¼€å§‹æ’­æ”¾
      if (needToPlay) {
        console.info('[PlayerPage] Starting playback for new episode');
        await this.playerService.playEpisode(episode);
      } else {
        // åŒæ­¥å½“å‰æ’­æ”¾çŠ¶æ€
        this.playerState = this.playerService.getState();
        this.currentPosition = this.playerService.getCurrentPosition();
        this.duration = this.playerService.getDuration();
      }
    } catch (error) {
      console.error('Failed to load episode:', error);
    }
  }

  startUpdateTimer() {
    this.updateTimer = setInterval(() => {
      if (this.playerState === PlayerState.PLAYING) {
        const newPosition = this.playerService.getCurrentPosition();
        const newDuration = this.playerService.getDuration();
        this.currentPosition = newPosition;
        this.duration = newDuration;
      }
      
      // æ›´æ–°ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
      this.sleepTimerRemaining = this.playerService.getSleepTimerRemaining();
      if (this.sleepTimerRemaining <= 0) {
        this.sleepTimerMinutes = 0;
      }
    }, 1000);
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      this.buildNavigationBar();

      Scroll() {
        Column() {
          // Episodeä¿¡æ¯
          this.buildEpisodeInfo();

          // è¿›åº¦æ¡
          this.buildProgressBar();

          // æ’­æ”¾æ§åˆ¶
          this.buildPlaybackControls();

          // åŠŸèƒ½æŒ‰é’®
          this.buildFunctionButtons();
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }

  @Builder
  buildNavigationBar() {
    Row() {
      Button() {
        Text('â†')
          .fontSize(22)
          .fontColor($r('app.color.text_primary'))
      }
      .width(44)
      .height(44)
      .backgroundColor($r('app.color.background_card'))
      .borderRadius(22)
      .onClick(() => {
        console.info('[PlayerPage] Back');
        UIUtils.back();
      })

      Blank()

      // æ›´å¤šæ“ä½œæŒ‰é’®
      Button() {
        Text('â‹®')
          .fontSize(22)
          .fontColor($r('app.color.text_primary'))
      }
      .width(44)
      .height(44)
      .backgroundColor($r('app.color.background_card'))
      .borderRadius(22)
      .onClick(() => {
        console.info('[PlayerPage] More options');
        this.showMoreOptionsMenu();
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  buildEpisodeInfo() {
    Column() {
      // å°é¢å›¾ - æ›´å¤§ï¼Œå¸¦é˜´å½±
      Image(this.currentEpisode?.imageUrl || '')
        .width(280)
        .height(280)
        .borderRadius(16)
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.app_icon'))
        .margin({ top: 20 })
        .shadow({
          radius: 30,
          color: 'rgba(0, 0, 0, 0.25)',
          offsetX: 0,
          offsetY: 10
        })

      // æ ‡é¢˜ - ä½¿ç”¨è·‘é©¬ç¯
      Marquee({
        start: this.playerState === PlayerState.PLAYING,
        step: 4,
        loop: -1,
        fromStart: true,
        src: this.marqueeText || this.currentEpisode?.title || ''
      })
        .width('85%')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ top: 20 })
        .allowScale(false)

      // æè¿°ï¼ˆç‚¹å‡»æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼‰
      Text(this.currentEpisode?.description || '')
        .fontSize(13)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('85%')
        .textAlign(TextAlign.Center)
        .onClick(() => {
          if (this.currentEpisode?.description) {
            this.showDescriptionDialog = true;
          }
        })
        .bindSheet($$this.showDescriptionDialog, this.buildDescriptionSheet(), {
          height: SheetSize.FIT_CONTENT,
          dragBar: true,
          showClose: true
        })
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
  }

  @Builder
  buildDescriptionSheet() {
    Column() {
      Text('å•é›†ç®€ä»‹')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })

      Scroll() {
        Text(this.formatDescription(this.currentEpisode?.description || ''))
          .fontSize(15)
          .fontColor($r('app.color.text_primary'))
          .lineHeight(24)
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .constraintSize({ maxHeight: 400 })
    }
    .width('100%')
    .padding(20)
  }

  /**
   * æ ¼å¼åŒ–æè¿°ï¼Œåœ¨æ—¶é—´æˆ³å‰æ¢è¡Œ
   */
  formatDescription(desc: string): string {
    if (!desc) return '';
    // åŒ¹é…æ—¶é—´æ ¼å¼: 02:02, 1:02:02 ç­‰ï¼Œåœ¨å‰é¢æ·»åŠ æ¢è¡Œ
    let result = desc.replace(/(\d{1,2}:\d{2}(?::\d{2})?)/g, '\n$1');
    // å»æ‰å¼€å¤´çš„æ¢è¡Œç¬¦
    return result.replace(/^\n/, '').trim();
  }

  @Builder
  buildProgressBar() {
    Column() {
      // åŠ è½½çŠ¶æ€æç¤º
      if (this.playerState === PlayerState.LOADING) {
        Text('æ­£åœ¨è¿æ¥ï¼Œè¯·ç¨å€™...')
          .fontSize(14)
          .fontColor($r('app.color.primary'))
          .margin({ bottom: 12 })
      }

      // æ—¶é—´æ˜¾ç¤º
      Row() {
        Text(this.formatTime(this.currentPosition))
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
          .fontWeight(FontWeight.Medium)

        Blank()

        Text(this.formatTime(this.duration))
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .margin({ bottom: 8 })
      
      // è¿›åº¦æ¡
      Slider({
        value: this.currentPosition,
        min: 0,
        max: this.duration,
        style: SliderStyle.OutSet
      })
        .width('100%')
        .trackColor($r('app.color.progress_track'))
        .selectedColor($r('app.color.primary'))
        .trackThickness(4)
        .onChange((value: number) => {
          this.playerService.seek(value);
        })
    }
    .width('100%')
    .padding({ left: 32, right: 32, top: 25 })
  }

  @Builder
  buildPlaybackControls() {
    Row() {
      // åé€€15ç§’
      Column() {
        Button() {
          Text('âª')
            .fontSize(24)
            .fontColor($r('app.color.primary'))
        }
        .width(56)
        .height(56)
        .backgroundColor('rgba(92, 107, 192, 0.08)')
        .borderRadius(28)
        .onClick(() => {
          console.info('[PlayerPage] Rewind 15s');
          const newPosition = Math.max(0, this.currentPosition - 15);
          this.playerService.seek(newPosition);
          UIUtils.showToast(new ToastOptions('å¿«é€€ 15 ç§’', 1000));
        })
        
        Text('15ç§’')
          .fontSize(11)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 4 })
      }
  
      Blank()
  
      // æ’­æ”¾/æš‚åœæŒ‰é’® - æ›´å¤§ã€æ›´çªå‡º
      Button() {
        if (this.playerState === PlayerState.LOADING) {
          LoadingProgress()
            .width(38)
            .height(38)
            .color($r('app.color.text_on_primary'))
        } else {
          Text(this.playerState === PlayerState.PLAYING ? 'â¸' : 'â–¶')
            .fontSize(38)
            .fontColor($r('app.color.text_on_primary'))
        }
      }
      .width(72)
      .height(72)
      .backgroundColor($r('app.color.primary'))
      .borderRadius(36)
      .shadow({
        radius: 12,
        color: 'rgba(92, 107, 192, 0.4)',
        offsetX: 0,
        offsetY: 4
      })
      .enabled(this.playerState !== PlayerState.LOADING)
      .onClick(() => {
        console.info(`[PlayerPage] Play/Pause, state: ${this.playerState}`);
        if (this.playerState === PlayerState.PLAYING) {
          this.playerService.pause();
        } else if (this.playerState === PlayerState.PAUSED) {
          this.playerService.resume();
        } else if (this.currentEpisode) {
          this.playerService.playEpisode(this.currentEpisode);
        }
      })
  
      Blank()
  
      // å‰è¿›30ç§’
      Column() {
        Button() {
          Text('â©')
            .fontSize(24)
            .fontColor($r('app.color.primary'))
        }
        .width(56)
        .height(56)
        .backgroundColor('rgba(92, 107, 192, 0.08)')
        .borderRadius(28)
        .onClick(() => {
          console.info('[PlayerPage] Forward 30s');
          const newPosition = Math.min(this.duration, this.currentPosition + 30);
          this.playerService.seek(newPosition);
          UIUtils.showToast(new ToastOptions('å¿«è¿› 30 ç§’', 1000));
        })
        
        Text('30ç§’')
          .fontSize(11)
          .fontColor($r('app.color.text_tertiary'))
          .margin({ top: 4 })
      }
    }
    .width('100%')
    .padding({ left: 50, right: 50, top: 20 })
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildFunctionButtons() {
    Column() {
      // ç¬¬ä¸€è¡Œï¼šæ’­æ”¾é€Ÿåº¦ã€å®šæ—¶å…³é—­
      Row() {
        // æ’­æ”¾é€Ÿåº¦
        Button() {
          Row() {
            Text('ğŸš€')
              .fontSize(16)
              .margin({ right: 6 })
            Text(`${this.playbackSpeed}x`)
              .fontSize(14)
              .fontColor($r('app.color.primary'))
              .fontWeight(FontWeight.Medium)
          }
        }
        .height(40)
        .padding({ left: 16, right: 16 })
        .backgroundColor('rgba(92, 107, 192, 0.08)')
        .borderRadius(20)
        .border({ width: 1, color: 'rgba(92, 107, 192, 0.2)', radius: 20 })
        .onClick(() => {
          console.info('[PlayerPage] Speed selector');
          this.showSpeedSelectorMenu();
        })

        Blank()

        // ç¡çœ å®šæ—¶å™¨
        Button() {
          Row() {
            Text('â°')
              .fontSize(16)
              .margin({ right: 6 })
            if (this.sleepTimerRemaining > 0) {
              Text(this.formatSleepTimer(this.sleepTimerRemaining))
                .fontSize(14)
                .fontColor($r('app.color.accent_red'))
                .fontWeight(FontWeight.Medium)
            } else {
              Text('å®šæ—¶')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
            }
          }
        }
        .height(40)
        .padding({ left: 16, right: 16 })
        .backgroundColor(this.sleepTimerRemaining > 0 ? 'rgba(255, 107, 107, 0.08)' : 'rgba(0, 0, 0, 0.05)')
        .borderRadius(20)
        .border({ 
          width: 1, 
          color: this.sleepTimerRemaining > 0 ? 'rgba(255, 107, 107, 0.3)' : 'rgba(0, 0, 0, 0.1)', 
          radius: 20 
        })
        .onClick(() => {
          console.info('[PlayerPage] Sleep timer');
          this.showSleepTimerMenu();
        })
      }
      .width('100%')
      .margin({ top: 20 })

      // ç¬¬äºŒè¡Œï¼šæ·»åŠ åˆ°é˜Ÿåˆ—
      Button() {
        Row() {
          Text('â•')
            .fontSize(16)
            .margin({ right: 6 })
          Text('æ·»åŠ åˆ°é˜Ÿåˆ—')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .width('100%')
      .height(44)
      .backgroundColor('rgba(0, 0, 0, 0.05)')
      .borderRadius(22)
      .border({ width: 1, color: 'rgba(0, 0, 0, 0.1)', radius: 22 })
      .margin({ top: 12 })
      .onClick(() => {
        console.info(`[PlayerPage] Add to queue: ${this.currentEpisode?.title || 'none'}`);
        if (!this.currentEpisode) {
          console.warn('No current episode to add to queue');
          return;
        }
        this.playerService.addToQueue(this.currentEpisode);
        UIUtils.showToast(new ToastOptions('å·²æ·»åŠ åˆ°é˜Ÿåˆ—', 2000));
      })
    }
    .width('100%')
    .padding({ left: 32, right: 32, bottom: 20 })
  }

  /**
   * æ ¼å¼åŒ–ç¡çœ å®šæ—¶å™¨å‰©ä½™æ—¶é—´
   */
  formatSleepTimer(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins > 0) {
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    } else {
      return `${secs}s`;
    }
  }

  showSpeedSelectorMenu(): void {
    // ç¬¦åˆä¸šç•Œæ ‡å‡†çš„æ’­æ”¾é€Ÿåº¦é€‰é¡¹
    // å‚è€ƒï¼šApple Podcasts, Spotify, Overcast ç­‰ä¸»æµæ’­å®¢åº”ç”¨
    const buttons: ButtonOptions[] = [
      new ButtonOptions('0.5x', '#000000'),   // æ…¢é€Ÿå­¦ä¹ 
      new ButtonOptions('0.75x', '#000000'),  // è¾ƒæ…¢
      new ButtonOptions('1.0x', '#000000'),   // æ­£å¸¸é€Ÿåº¦
      new ButtonOptions('1.25x', '#000000'),  // ç¨å¿«
      new ButtonOptions('1.5x', '#000000'),   // è¾ƒå¿«
      new ButtonOptions('1.75x', '#000000'),  // å¾ˆå¿«
      new ButtonOptions('2.0x', '#000000'),   // 2å€é€Ÿ
      new ButtonOptions('2.5x', '#000000'),   // æå¿«
      new ButtonOptions('3.0x', '#000000')    // æœ€å¿«
    ];
    UIUtils.showActionMenu(new ActionMenuOptions('é€‰æ‹©æ’­æ”¾é€Ÿåº¦', buttons)).then((index: number) => {
      if (index >= 0) {
        const speeds: number[] = [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.5, 3.0];
        const selectedSpeed = speeds[index];
        this.playbackSpeed = selectedSpeed;
        this.playerService.setPlaybackSpeed(selectedSpeed);
        // ä¿å­˜åˆ°è®¾ç½®ä¸­ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶è®°ä½
        const settingsService = SettingsService.getInstance();
        settingsService.setPlaybackSpeed(selectedSpeed);
        console.info(`[PlayerPage] Playback speed set to ${selectedSpeed}x and saved`);
      }
    });
  }

  showSleepTimerMenu(): void {
    const buttons: ButtonOptions[] = [
      new ButtonOptions('å…³é—­å®šæ—¶', '#000000'),
      new ButtonOptions('5 åˆ†é’Ÿ', '#000000'),
      new ButtonOptions('15 åˆ†é’Ÿ', '#000000'),
      new ButtonOptions('30 åˆ†é’Ÿ', '#000000'),
      new ButtonOptions('45 åˆ†é’Ÿ', '#000000'),
      new ButtonOptions('60 åˆ†é’Ÿ', '#000000')
    ];
    UIUtils.showActionMenu(new ActionMenuOptions('å®šæ—¶å…³é—­', buttons)).then((index: number) => {
      if (index >= 0) {
        const minutesOptions: number[] = [0, 5, 15, 30, 45, 60];
        const minutes = minutesOptions[index];
        this.sleepTimerMinutes = minutes;
        this.playerService.setSleepTimer(minutes);
        const msg = minutes > 0 ? `å·²è®¾ç½®å®šæ—¶å…³é—­ï¼š${minutes} åˆ†é’Ÿ` : 'å·²å…³é—­å®šæ—¶æ’­æ”¾';
        UIUtils.showToast(new ToastOptions(msg, 2000));
      }
    });
  }

  formatTime(seconds: number): string {
    const totalSeconds = Math.floor(seconds);
    const minutes = Math.floor(totalSeconds / 60);
    const hours = Math.floor(minutes / 60);
    const remainingSeconds = totalSeconds % 60;

    if (hours > 0) {
      return `${hours}:${(minutes % 60).toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    } else {
      return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
  }

  /**
   * åˆ†äº«å•é›†
   */
  shareEpisode(): void {
    if (!this.currentEpisode) {
      return;
    }

    const shareText = `æˆ‘æ­£åœ¨å¬ã€Š${this.currentEpisode.title}ã€‹

${this.currentEpisode.description}

åˆ†äº«è‡ª AntennaPodHM`;
    
    const buttons: ButtonOptions[] = [
      new ButtonOptions('å¾®ä¿¡å¥½å‹', '#000000'),
      new ButtonOptions('å¾®ä¿¡æœ‹å‹åœˆ', '#000000'),
      new ButtonOptions('å¤åˆ¶é“¾æ¥', '#000000'),
      new ButtonOptions('æ›´å¤šåˆ†äº«æ–¹å¼', '#000000')
    ];
    UIUtils.showActionMenu(new ActionMenuOptions('åˆ†äº«åˆ°', buttons)).then((index: number) => {
      if (index >= 0) {
        switch (index) {
          case 0:
            this.shareToWeChatFriend();
            break;
          case 1:
            this.shareToWeChatMoments();
            break;
          case 2:
            this.copyShareLink();
            break;
          case 3:
            this.systemShare();
            break;
        }
      }
    });
  }

  /**
   * åˆ†äº«åˆ°å¾®ä¿¡å¥½å‹
   */
  shareToWeChatFriend(): void {
    if (!this.currentEpisode) {
      return;
    }
    
    // HarmonyOSæš‚ä¸æ”¯æŒç›´æ¥è°ƒç”¨å¾®ä¿¡SDKï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿåˆ†äº«æˆ–å¤åˆ¶é“¾æ¥
    const buttons: ButtonOptions[] = [
      new ButtonOptions('å–æ¶ˆ', '#999999'),
      new ButtonOptions('å¤åˆ¶é“¾æ¥', '#007AFF')
    ];
    UIUtils.showDialog(new DialogOptions(
      'åˆ†äº«åˆ°å¾®ä¿¡',
      'ç”±äºç³»ç»Ÿé™åˆ¶ï¼Œæš‚ä¸æ”¯æŒç›´æ¥åˆ†äº«åˆ°å¾®ä¿¡ã€‚\n\nå»ºè®®æ“ä½œï¼š\n1. ç‚¹å‡»"å¤åˆ¶é“¾æ¥"å¤åˆ¶åˆ†äº«å†…å®¹\n2. æ‰‹åŠ¨æ‰“å¼€å¾®ä¿¡å‘é€ç»™å¥½å‹',
      buttons
    )).then((index: number) => {
      if (index === 1) {
        this.copyShareLink();
      }
    });
    
    console.info('[PlayerPage] Share to WeChat friend:', this.currentEpisode?.title);
  }

  /**
   * åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ
   */
  shareToWeChatMoments(): void {
    if (!this.currentEpisode) {
      return;
    }
    
    // HarmonyOSæš‚ä¸æ”¯æŒç›´æ¥è°ƒç”¨å¾®ä¿¡SDKï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿåˆ†äº«æˆ–å¤åˆ¶é“¾æ¥
    const buttons: ButtonOptions[] = [
      new ButtonOptions('å–æ¶ˆ', '#999999'),
      new ButtonOptions('å¤åˆ¶é“¾æ¥', '#007AFF')
    ];
    UIUtils.showDialog(new DialogOptions(
      'åˆ†äº«åˆ°æœ‹å‹åœˆ',
      'ç”±äºç³»ç»Ÿé™åˆ¶ï¼Œæš‚ä¸æ”¯æŒç›´æ¥åˆ†äº«åˆ°æœ‹å‹åœˆã€‚\n\nå»ºè®®æ“ä½œï¼š\n1. ç‚¹å‡»"å¤åˆ¶é“¾æ¥"å¤åˆ¶åˆ†äº«å†…å®¹\n2. æ‰‹åŠ¨æ‰“å¼€å¾®ä¿¡å‘å¸ƒåˆ°æœ‹å‹åœˆ',
      buttons
    )).then((index: number) => {
      if (index === 1) {
        this.copyShareLink();
      }
    });
    
    console.info('[PlayerPage] Share to WeChat moments:', this.currentEpisode?.title);
  }

  /**
   * å¤åˆ¶åˆ†äº«é“¾æ¥
   */
  async copyShareLink(): Promise<void> {
    if (!this.currentEpisode) {
      return;
    }
    
    try {
      const shareText = `æˆ‘æ­£åœ¨å¬ã€Š${this.currentEpisode.title}ã€‹

${this.currentEpisode.description}

åˆ†äº«è‡ª AntennaPodHM`;
      
      // åˆ›å»ºå‰ªè´´æ¿æ•°æ®
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, shareText);
      
      // è·å–ç³»ç»Ÿå‰ªè´´æ¿å®ä¾‹
      const systemPasteboard = pasteboard.getSystemPasteboard();
      
      // å°†æ•°æ®å†™å…¥å‰ªè´´æ¿
      await systemPasteboard.setData(pasteData);
      
      UIUtils.showToast(new ToastOptions('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 2000));
      
      console.info('[PlayerPage] Copy share link success:', shareText);
    } catch (error) {
      const err = error as BusinessError;
      console.error(`[PlayerPage] Copy share link failed: ${err.code}, ${err.message}`);
      
      UIUtils.showToast(new ToastOptions('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•', 2000));
    }
  }

  /**
   * ç³»ç»Ÿåˆ†äº«
   */
  async systemShare(): Promise<void> {
    if (!this.currentEpisode) {
      return;
    }
    
    // HarmonyOS ç›®å‰çš„ç³»ç»Ÿåˆ†äº«APIè¾ƒä¸ºå¤æ‚ï¼Œç›´æ¥ä½¿ç”¨å¤åˆ¶åˆ°å‰ªè´´æ¿ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ
    const buttons: ButtonOptions[] = [
      new ButtonOptions('å–æ¶ˆ', '#999999'),
      new ButtonOptions('å¤åˆ¶', '#007AFF')
    ];
    UIUtils.showDialog(new DialogOptions(
      'åˆ†äº«',
      'å°†åˆ†äº«å†…å®¹å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œç„¶åæ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»ä½•åº”ç”¨ä¸­åˆ†äº«ã€‚',
      buttons
    )).then((index: number) => {
      if (index === 1) {
        this.copyShareLink();
      }
    });
    
    console.info('[PlayerPage] System share initiated');
  }

  /**
   * æ˜¾ç¤ºæ›´å¤šé€‰é¡¹èœå•
   */
  showMoreOptionsMenu(): void {
    const buttons: ButtonOptions[] = [
      new ButtonOptions('æŸ¥çœ‹å•é›†è¯¦æƒ…', '#000000'),
      new ButtonOptions('åˆ†äº«è¿™ä¸€é›†', '#000000'),
      new ButtonOptions('ä¸‹è½½åˆ°æœ¬åœ°', '#000000')
    ];
    UIUtils.showActionMenu(new ActionMenuOptions('æ›´å¤šé€‰é¡¹', buttons)).then((index: number) => {
      if (index >= 0) {
        switch (index) {
          case 0:
            // æŸ¥çœ‹å•é›†è¯¦æƒ…
            if (this.currentEpisode) {
              const params = new RouteParams();
              params.episodeId = this.currentEpisode.id;
              UIUtils.pushUrl('pages/EpisodeDetailPage', params);
            }
            break;
          case 1:
            // åˆ†äº«
            if (this.currentEpisode) {
              this.shareEpisode();
            } else {
              UIUtils.showToast(new ToastOptions('æš‚æ— å¯åˆ†äº«çš„å†…å®¹', 2000));
            }
            break;
          case 2:
            // ä¸‹è½½
            if (this.currentEpisode) {
              DownloadService.getInstance().downloadEpisode(this.currentEpisode)
                .then(() => {
                  UIUtils.showToast(new ToastOptions('å·²æ·»åŠ åˆ°ä¸‹è½½é˜Ÿåˆ—', 2000));
                })
                .catch((err: Error) => {
                  console.error('Download failed:', err);
                  UIUtils.showToast(new ToastOptions('ä¸‹è½½å¤±è´¥', 2000));
                });
            }
            break;
        }
      }
    });
  }
}
